/**
 * @fileoverview Firestore Security Rules
 * @author service-llm
 *
 * @description
 * This ruleset governs access to the job postings, applications, and M365 inquiry data for the ConsultFast application.
 *
 * @philosophy
 * Core Philosophy: The security model prioritizes public visibility for job postings while ensuring the privacy and integrity of submitted data like job applications and M365 inquiries. Job postings are publicly readable. Submissions from the public (applications, inquiries) follow a "write-once, read-never" pattern from the client-side. This means anyone can submit data, but once submitted, it cannot be viewed, listed, or modified by any client, protecting submitter privacy. Management of job postings is currently disabled pending schema updates.
 *
 * @structure
 * Data Structure: The data is organized around top-level collections. `jobPostings` holds job details, with nested `jobApplications` for applications. `m365Inquiries` is a separate top-level collection for M365 licensing contact submissions.
 *
 * @decisions
 * Key Security Decisions:
 * 1. Public Job Postings: `jobPostings` is publicly readable to allow any visitor to browse opportunities.
 * 2. Write-Restricted Postings: Creating, updating, or deleting job postings is disabled by default because the 'JobPosting' entity lacks an 'ownerId' field.
 * 3. Secure Submissions: Anyone can create documents in `jobApplications` and `m365Inquiries`, enabling public forms.
 * 4. Private Submitted Data: To protect sensitive information, all read and modification access (`get`, `list`, `update`, `delete`) to `jobApplications` and `m365Inquiries` is strictly denied from the client-side. Data is assumed to be processed by a trusted server environment.
 *
 * @denormalization
 * Denormalization for Authorization: This ruleset is simple. The hierarchical structure for jobs/applications simplifies path-based security. The standalone `m365Inquiries` collection keeps contact data isolated.
 *
 * @segregation
 * Structural Segregation: Using a nested subcollection for `jobApplications` and a separate top-level collection for `m365Inquiries` naturally segregates private data from public data, which is a secure and performant pattern.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper Functions
    /**
     * Returns true. Used for rules that grant public access.
     */
    function isPublic() {
      return true;
    }

    /**
     * Returns false. Used to explicitly deny permissions.
     */
    function isDenied() {
      return false;
    }

    /**
     * Checks if the incoming job application data is valid.
     * Ensures relational integrity and required fields are present.
     */
    function newApplicationIsValid(jobPostingId) {
      let incomingData = request.resource.data;
      return incomingData.jobPostingId == jobPostingId &&
             incomingData.jobTitle is string && incomingData.jobTitle.size() > 0 &&
             incomingData.applicantName is string && incomingData.applicantName.size() > 0 &&
             incomingData.applicantEmail is string && incomingData.applicantEmail.matches('.+@.+\..+') &&
             incomingData.resumeUrl is string && incomingData.resumeUrl.size() > 0 &&
             incomingData.submissionDate is string;
    }
    
    /**
     * Checks if the incoming M365 inquiry data is valid.
     */
    function newM365InquiryIsValid() {
      let d = request.resource.data;
      return d.fname is string && d.fname.size() > 0 &&
             d.lname is string && d.lname.size() > 0 &&
             d.email is string && d.email.matches('.+@.+\..+') &&
             d.phone is string && d.phone.size() > 0 &&
             d.company is string && d.company.size() > 0 &&
             d.requirements is string && d.requirements.size() > 0 &&
             d.submissionDate is string;
    }

    /**
     * @description
     * Rules for the `jobPostings` collection.
     * @path /jobPostings/{jobPostingId}
     */
    match /jobPostings/{jobPostingId} {
      allow get: if isPublic();
      allow list: if isPublic();

      // CRITICAL: Cannot implement owner-only writes. The 'JobPosting' entity is missing an 'ownerId' or 'authorId' field.
      allow create, update, delete: if isDenied();

      /**
       * @description
       * Rules for the `jobApplications` subcollection. Allows public submission, denies all other access.
       * @path /jobPostings/{jobPostingId}/jobApplications/{jobApplicationId}
       */
      match /jobApplications/{jobApplicationId} {
        allow create: if newApplicationIsValid(jobPostingId);
        allow get, list, update, delete: if isDenied();
      }
    }
    
    /**
     * @description
     * Rules for the `m365Inquiries` collection. Allows anyone to submit an inquiry,
     * but denies all read and modification access to protect PII.
     * @path /m365Inquiries/{inquiryId}
     */
    match /m365Inquiries/{inquiryId} {
        allow create: if newM365InquiryIsValid();
        allow get, list, update, delete: if isDenied();
    }
  }
}
